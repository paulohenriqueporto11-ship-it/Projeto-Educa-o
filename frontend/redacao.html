<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escrever Reda√ß√£o</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4F46E5;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg: #F9FAFB;
            --surface: #ffffff;
            --border: #E5E7EB;
            --text: #1F2937;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar (Esquerda) */
        aside {
            width: 300px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            box-shadow: 4px 0 24px rgba(0,0,0,0.02);
            z-index: 10;
        }

        .brand { font-weight: 800; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 8px; cursor: pointer; text-decoration: none;}
        
        .info-box { background: #F3F4F6; padding: 16px; border-radius: 12px; }
        .info-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #6B7280; font-weight: 600; margin-bottom: 4px; }
        .info-content { font-weight: 600; font-size: 1rem; color: #111827; }

        .timer-box { text-align: center; background: #EEF2FF; color: var(--primary); padding: 15px; border-radius: 12px; font-variant-numeric: tabular-nums; font-size: 1.5rem; font-weight: 700; }

        /* Main Area (Direita) */
        main { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        
        .editor-container { width: 100%; max-width: 800px; position: relative; }
        
        .editor-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .counters { font-size: 0.85rem; color: #6B7280; }

        textarea {
            width: 100%; height: 60vh; padding: 24px;
            border: 2px solid var(--border); border-radius: 12px;
            font-size: 1.1rem; line-height: 1.6; font-family: 'Inter', sans-serif;
            resize: none; outline: none; transition: border-color 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }

        .btn-submit {
            width: 100%; margin-top: 20px; padding: 16px;
            background: var(--primary); color: white; border: none; border-radius: 12px;
            font-size: 1.1rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        .btn-submit:hover { background: #4338ca; transform: translateY(-2px); }
        .btn-submit:disabled { background: #9CA3AF; cursor: not-allowed; transform: none; }

        /* Results Modal/Section */
        #results-area { display: none; width: 100%; max-width: 800px; margin-top: 40px; padding-bottom: 50px; }
        
        .score-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .final-score { font-size: 3rem; font-weight: 800; color: var(--text); }
        .final-score span { font-size: 1rem; color: #6B7280; font-weight: 500; }

        .comp-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px; margin-bottom: 16px;
            transition: all 0.2s;
        }
        .comp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .comp-title { font-weight: 600; color: var(--text); }
        
        /* Progress Bar */
        .progress-bg { height: 8px; background: #E5E7EB; border-radius: 4px; overflow: hidden; width: 100%; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 1s ease; }

        .feedback-item {
            margin-top: 12px; padding: 12px; background: #FEF2F2; 
            border-left: 4px solid var(--danger); border-radius: 4px; font-size: 0.9rem;
        }
        .feedback-title { font-weight: 700; color: #991B1B; margin-bottom: 4px; display: block; }
        .feedback-fix { color: var(--success); font-weight: 600; margin-top: 4px; display: block; font-size: 0.85rem;}

        /* Mobile */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; }
            aside { width: 100%; padding: 16px; flex-direction: row; align-items: center; justify-content: space-between; gap: 10px; }
            .info-box { display: none; } /* Esconde tema no mobile pra ganhar espa√ßo */
            .timer-box { font-size: 1.2rem; padding: 8px; }
            main { padding: 20px; }
            textarea { height: 50vh; }
        }
    </style>
</head>
<body>

    <aside>
        <a href="index.html" class="brand">‚Üê Voltar</a>
        
        <div class="info-box">
            <div class="info-label">Tema da Reda√ß√£o</div>
            <div class="info-content" id="temaDisplay">Carregando...</div>
        </div>

        <div class="timer-box" id="timer">01:00:00</div>
        
        <div style="flex:1"></div> </aside>

    <main>
        <div class="editor-container" id="editorArea">
            <div class="editor-header">
                <h3>Sua Reda√ß√£o</h3>
                <div class="counters">
                    <span id="wordCount">0</span> palavras ‚Ä¢ <span id="charCount">0</span> caracteres
                </div>
            </div>
            
            <textarea id="textoRedacao" placeholder="Comece a escrever sua reda√ß√£o aqui..."></textarea>
            <button class="btn-submit" onclick="enviarRedacao()" id="btnEnviar">Entregar Reda√ß√£o</button>
        </div>

        <div id="results-area">
            <div class="score-header">
                <div>
                    <h2>Boletim de Desempenho</h2>
                    <p style="color:#6B7280">An√°lise baseada nos crit√©rios do ENEM</p>
                </div>
                <div class="final-score" id="notaFinal">0 <span>/ 1000</span></div>
            </div>
            <div id="competenciasList"></div>
            
            <button class="btn-submit" style="background:var(--bg); color:var(--text); border:1px solid var(--border)" onclick="location.reload()">Escrever Outra</button>
        </div>
    </main>

<script>
    // ‚ö†Ô∏è TROQUE PELA URL DO SEU RENDER
    const API_URL = "https://backend-redacao.onrender.com/api/enviar-redacao";

    // Setup inicial
    const tema = localStorage.getItem('temaRedacao') || "Tema Livre";
    document.getElementById('temaDisplay').innerText = tema;

    // Contadores em tempo real
    const textarea = document.getElementById('textoRedacao');
    textarea.addEventListener('input', () => {
        const txt = textarea.value;
        document.getElementById('charCount').innerText = txt.length;
        document.getElementById('wordCount').innerText = txt.trim() === '' ? 0 : txt.trim().split(/\s+/).length;
    });

    // Cron√¥metro
    let tempo = 3600;
    const timerInterval = setInterval(() => {
        tempo--;
        if(tempo < 0) { clearInterval(timerInterval); alert("Tempo Esgotado!"); return; }
        const h = Math.floor(tempo/3600).toString().padStart(2,'0');
        const m = Math.floor((tempo%3600)/60).toString().padStart(2,'0');
        const s = (tempo%60).toString().padStart(2,'0');
        document.getElementById('timer').innerText = `${h}:${m}:${s}`;
    }, 1000);

    // L√≥gica de Envio
    async function enviarRedacao() {
        const txt = textarea.value;
        if(txt.length < 50) return alert("Texto muito curto!");

        const btn = document.getElementById('btnEnviar');
        btn.disabled = true;
        btn.innerText = "Corrigindo (IA Analisando)...";

        try {
            const res = await fetch(API_URL, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ texto: txt, tema: tema })
            });
            const data = await res.json();

            if(data.sucesso) {
                mostrarResultados(data.resultado);
                clearInterval(timerInterval);
                document.getElementById('editorArea').style.display = 'none';
                document.getElementById('results-area').style.display = 'block';
            } else {
                alert(data.erro || "Erro desconhecido");
                btn.disabled = false;
                btn.innerText = "Entregar Reda√ß√£o";
            }
        } catch(e) {
            console.error(e);
            alert("Erro de conex√£o. Servidor pode estar dormindo (Cold Start). Tente novamente em 30s.");
            btn.disabled = false;
            btn.innerText = "Tentar Novamente";
        }
    }

    function mostrarResultados(res) {
        document.getElementById('notaFinal').innerHTML = `${res.notaFinal} <span>/ 1000</span>`;
        const container = document.getElementById('competenciasList');
        container.innerHTML = '';

        // Erros Gerais (Spam)
        if(res.analiseGeral && res.analiseGeral.length > 0) {
            container.innerHTML += `<div style="background:#FEF2F2; color:#991B1B; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #FCA5A5">üö® ${res.analiseGeral.join('<br>')}</div>`;
        }

        // Compet√™ncias
        const comps = res.competencias;
        Object.keys(comps).forEach(key => {
            const c = comps[key];
            const percent = (c.nota / 200) * 100;
            let color = '#10B981'; // Verde
            if(c.nota < 120) color = '#EF4444'; // Vermelho
            else if(c.nota < 160) color = '#F59E0B'; // Amarelo

            let html = `
                <div class="comp-card">
                    <div class="comp-header">
                        <span class="comp-title">${c.nome}</span>
                        <span style="font-weight:700; color:${color}">${c.nota}/200</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-fill" style="width:${percent}%; background:${color}"></div>
                    </div>
            `;

            if(c.erros && c.erros.length > 0) {
                html += `<div style="margin-top:15px">`;
                c.erros.forEach(err => {
                    // Compatibilidade com V8/V9 (Objeto ou String)
                    if(typeof err === 'object') {
                        html += `
                            <div class="feedback-item">
                                <span class="feedback-title">${err.tipo}: ${err.descricao}</span>
                                <div style="color:#4B5563; margin-bottom:4px">‚ùå Problema: ${err.exemplo}</div>
                                <span class="feedback-fix">üí° Dica: ${err.acao}</span>
                            </div>`;
                    } else {
                        html += `<div class="feedback-item">${err}</div>`;
                    }
                });
                html += `</div>`;
            } else if (c.nota === 200) {
                html += `<div style="margin-top:10px; color:#10B981; font-size:0.9rem">‚ú® Desempenho impec√°vel!</div>`;
            }

            html += `</div>`;
            container.innerHTML += html;
        });
    }
</script>
</body>
</html>
