<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escrever Reda√ß√£o</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #e9ecef; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 900px; display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        
        /* √Årea da Esquerda (Editor) */
        .editor-area { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* √Årea da Direita (Infos) */
        .info-area { display: flex; flex-direction: column; gap: 20px; }
        .card-info { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        h2 { margin-top: 0; color: #343a40; font-size: 18px; }
        #temaDisplay { color: #007bff; font-weight: bold; font-size: 1.1em; }
        
        textarea { width: 100%; height: 500px; padding: 15px; border: 1px solid #ced4da; border-radius: 8px; font-size: 16px; resize: none; margin-top: 10px; box-sizing: border-box; line-height: 1.5; }
        textarea:focus { outline: 2px solid #007bff; border-color: transparent; }

        .btn-enviar { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .btn-enviar:hover { background: #218838; }

        /* Cron√¥metro */
        .timer { font-size: 2em; font-weight: bold; text-align: center; color: #495057; font-family: monospace; }
        
        /* Boletim de Notas */
        .scorecard { display: none; }
        .comp-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .comp-nota { font-weight: bold; }
        .nota-final { font-size: 2.5em; text-align: center; color: #28a745; margin: 20px 0; font-weight: bold; }
        .feedback-erro { color: #dc3545; font-size: 0.85em; margin-top: 5px; background: #fff5f5; padding: 5px; border-radius: 4px; }

        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="editor-area">
        <div style="margin-bottom: 20px;">
            <span style="color:#6c757d; font-size: 0.9em;">TEMA DA REDA√á√ÉO:</span><br>
            <span id="temaDisplay">Carregando tema...</span>
        </div>
        <textarea id="textoRedacao" placeholder="Comece a digitar sua reda√ß√£o aqui..."></textarea>
        <button class="btn-enviar" onclick="enviarRedacao()" id="btnEnviar">ENTREGAR REDA√á√ÉO</button>
    </div>

    <div class="info-area">
        <div class="card-info">
            <h2>‚è±Ô∏è Tempo Restante</h2>
            <div class="timer" id="timer">01:00:00</div>
        </div>

        <div class="card-info scorecard" id="scorecard">
            <h2>üìä Boletim de Desempenho</h2>
            <div class="nota-final" id="notaFinal">0</div>
            
            <div id="listaCompetencias">
                </div>
        </div>
    </div>
</div>

<script>
    // URL DO SEU BACKEND (Troque se necess√°rio)
    const API_URL = "https://backend-redacao.onrender.com/api/enviar-redacao";

    // Inicializa√ß√£o
    const tema = localStorage.getItem('temaRedacao') || "Tema Livre";
    document.getElementById('temaDisplay').innerText = tema;

    // Cron√¥metro (1 Hora)
    let tempoRestante = 3600; // segundos
    const timerElem = document.getElementById('timer');
    
    const intervalo = setInterval(() => {
        tempoRestante--;
        if (tempoRestante < 0) {
            clearInterval(intervalo);
            alert("Tempo esgotado!");
            return;
        }
        const h = Math.floor(tempoRestante / 3600).toString().padStart(2, '0');
        const m = Math.floor((tempoRestante % 3600) / 60).toString().padStart(2, '0');
        const s = (tempoRestante % 60).toString().padStart(2, '0');
        timerElem.innerText = `${h}:${m}:${s}`;
    }, 1000);

    // Envio
    async function enviarRedacao() {
        const texto = document.getElementById('textoRedacao').value;
        const btn = document.getElementById('btnEnviar');
        const scorecard = document.getElementById('scorecard');

        if (texto.split(' ').length < 10) return alert("Escreva um pouco mais!");

        btn.disabled = true;
        btn.innerText = "Corrigindo (IA Analisando)...";

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                // Envia o TEXTO e o TEMA para o backend
                body: JSON.stringify({ texto: texto, tema: tema })
            });

            const data = await response.json();

            if (data.sucesso) {
                mostrarResultado(data.resultado);
                clearInterval(intervalo); // Para o tempo
            } else {
                alert("Erro: " + (data.erro || "Falha na corre√ß√£o"));
            }

        } catch (e) {
            console.error(e);
            alert("Erro de conex√£o com o servidor.");
        } finally {
            btn.disabled = false;
            btn.innerText = "ENTREGAR REDA√á√ÉO";
        }
    }

    function mostrarResultado(res) {
        document.getElementById('scorecard').style.display = 'block';
        document.getElementById('notaFinal').innerText = res.notaFinal;
        
        const lista = document.getElementById('listaCompetencias');
        lista.innerHTML = '';

        // Itera sobre as competencias (c1, c2, c3...)
        Object.keys(res.competencias).forEach(key => {
            const comp = res.competencias[key];
            let cor = comp.nota >= 160 ? '#28a745' : (comp.nota >= 120 ? '#ffc107' : '#dc3545');
            
            let html = `
                <div style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom:10px">
                    <div class="comp-row">
                        <span>${comp.nome}</span>
                        <span style="color:${cor}; font-weight:bold">${comp.nota}/200</span>
                    </div>
            `;

            // Lista os erros/dicas se houver
            if (comp.erros && comp.erros.length > 0) {
                comp.erros.forEach(erro => {
                    html += `<div class="feedback-erro">‚ö†Ô∏è ${erro}</div>`;
                });
            } else if (comp.nota === 200) {
                 html += `<div style="color:#28a745; font-size:0.8em; margin-top:5px">‚úÖ Excelente!</div>`;
            }

            html += `</div>`;
            lista.innerHTML += html;
        });

        // Se tiver erro global (spam etc)
        if (res.analiseGeral && res.analiseGeral.length > 0) {
             lista.innerHTML += `<div style="background:#ffd2d2; color:#a00; padding:10px; border-radius:5px; margin-top:10px">üö® ${res.analiseGeral.join(' ')}</div>`;
        }
    }
</script>

</body>
</html>
