<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor - Estuda.IA</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4F46E5">

    <link href="assets/css/style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="editor-layout">

    <div class="editor-box" id="editorArea">
        <div class="editor-header">
            <a href="index.html" style="font-weight:600; color:var(--primary)">‚Üê Voltar</a>
            <div class="timer-badge" id="timer">01:00:00</div>
        </div>

        <h3 style="color:var(--text-muted); font-size:0.8rem; text-transform:uppercase;">Tema da Reda√ß√£o</h3>
        <div id="temaDisplay" style="font-weight:700; font-size:1.1rem; margin-bottom:20px;">...</div>

        <textarea id="texto" class="main-input" placeholder="Digite sua reda√ß√£o aqui..."></textarea>
        <div class="counters"><span id="words">0</span> palavras</div>

        <button class="btn" style="width:100%" onclick="enviar()" id="btnEnviar">ENTREGAR REDA√á√ÉO</button>
    </div>

    <div id="results" class="results-container">
        <div class="score-hero">
            <div class="val" id="finalScore">0</div>
            <div class="label">NOTA FINAL</div>
        </div>

        <div id="compList"></div>

        <div style="margin-top: 30px; display: flex; gap: 10px;">
            <button class="btn btn-outline" style="flex:1" onclick="location.reload()">Nova Reda√ß√£o</button>
            <a href="index.html" class="btn" style="flex:1">Voltar ao Menu</a>
        </div>
    </div>

    <script>
        const API_URL = "https://backend-redacao.onrender.com/api/enviar-redacao";
        
        const tema = localStorage.getItem('temaRedacao') || "Tema Livre";
        document.getElementById('temaDisplay').innerText = tema;
        const txtArea = document.getElementById('texto');
        
        txtArea.addEventListener('input', () => {
            const w = txtArea.value.trim() === '' ? 0 : txtArea.value.trim().split(/\s+/).length;
            document.getElementById('words').innerText = w;
        });

        let t = 3600;
        setInterval(() => {
            t--; if(t<0) return;
            const m = Math.floor(t/60);
            const s = t%60;
            document.getElementById('timer').innerText = `${Math.floor(m/60)}:${(m%60).toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }, 1000);

        async function enviar() {
            const texto = txtArea.value;
            if(texto.length < 50) return alert("Texto muito curto!");
            
            const btn = document.getElementById('btnEnviar');
            btn.disabled = true; btn.innerText = "Corrigindo...";

            let userId = localStorage.getItem('estudaia_id');
            if(!userId) { userId = 'anon_' + Date.now(); localStorage.setItem('estudaia_id', userId); }

            try {
                const res = await fetch(API_URL, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ texto, tema, userId })
                });
                const data = await res.json();
                
                if(data.sucesso) {
                    mostrarResultado(data.resultado);
                    document.getElementById('editorArea').style.display = 'none';
                    document.getElementById('results').style.display = 'block';
                } else {
                    alert(data.erro);
                    btn.disabled = false; btn.innerText = "ENTREGAR REDA√á√ÉO";
                }
            } catch(e) {
                alert("Erro de conex√£o.");
                btn.disabled = false; btn.innerText = "ENTREGAR REDA√á√ÉO";
            }
        }

        function mostrarResultado(res) {
            document.getElementById('finalScore').innerText = res.notaFinal;
            const list = document.getElementById('compList');
            list.innerHTML = '';
            
            if(res.analiseGeral.length > 0) {
                list.innerHTML += `<div style="background:#FEE2E2; color:#991B1B; padding:15px; border-radius:8px; margin-bottom:20px">üö® ${res.analiseGeral.join('<br>')}</div>`;
            }

            Object.values(res.competencias).forEach(c => {
                let color = c.nota >= 160 ? 'var(--success)' : c.nota >= 120 ? 'var(--warning)' : 'var(--danger)';
                let html = `
                    <div class="comp-card">
                        <div class="comp-header"><span>${c.nome}</span> <span style="color:${color}">${c.nota}/200</span></div>
                        <div class="progress-track"><div class="progress-fill" style="width:${(c.nota/200)*100}%; background:${color}"></div></div>
                `;
                
                c.erros.forEach(e => {
                    if(typeof e === 'object') {
                        html += `<div class="feedback-item"><strong>${e.descricao}</strong>‚ùå ${e.exemplo}<small>üí° ${e.acao}</small></div>`;
                    } else {
                        html += `<div class="feedback-item">${e}</div>`;
                    }
                });
                
                html += `</div>`;
                list.innerHTML += html;
            });
        }
    </script>
</body>
</html>
