<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Reda√ß√£o - Estuda.IA</title>
   <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="assets/icons/icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="auth.js"></script>
</head>
<body>

    <nav>
        <div class="nav-left">
            <a href="index.html" class="btn-outline" style="border:none; padding:8px 12px; margin-right:15px; font-weight:600;">‚¨Ö Voltar</a>
            <div class="logo">üìù Reda√ß√£o.IA</div>
        </div>
        <div class="nav-right">
             <div class="study-timer" id="wordCount">0 palavras</div>
             <a id="authBtn" href="login.html" class="btn-outline" style="border:none; font-weight:600; margin-left:10px;">Entrar</a>
        </div>
    </nav>

    <div class="container">
        <div style="background:white; padding:20px; border-radius:16px; border:1px solid var(--border); margin-bottom:20px; box-shadow: var(--shadow-sm);">
            <span style="text-transform:uppercase; font-size:0.75rem; color:var(--text-muted); font-weight:700;">Tema Escolhido</span>
            <h2 id="temaDisplay" style="margin-top:5px; color:var(--primary);">Carregando tema...</h2>
        </div>

        <div class="editor-box" style="width:100%; max-width:100%; padding:0; background:transparent; border:none; box-shadow:none;">
            <textarea id="textoRedacao" class="main-input" placeholder="Comece a digitar sua reda√ß√£o aqui... M√≠nimo 50 caracteres." oninput="contarPalavras()"></textarea>
            
            <div style="display:flex; justify-content:flex-end; margin-top:20px;">
                <button id="btnEnviar" class="btn" onclick="enviarParaCorrecao()">
                    üöÄ Enviar para Corre√ß√£o
                </button>
            </div>
        </div>

        <div id="resultadoContainer" style="display:none; margin-top:30px; animation: slideUp 0.5s ease;">
            <div class="score-hero">
                <div class="val" id="notaFinal">0</div>
                <div class="label">Nota Geral</div>
            </div>

            <div style="background:white; padding:25px; border-radius:16px; border:1px solid var(--border); margin-top:20px;">
                <h3>üìä An√°lise Detalhada</h3>
                <div id="feedbackTexto" style="margin-top:15px; line-height:1.6; color:var(--text-main);"></div>
            </div>
            
            <button class="btn-outline" style="width:100%; margin-top:20px; padding:15px;" onclick="window.location.href='index.html'">
                Voltar ao Painel
            </button>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loader"></div>
        <div class="loading-text">A Intelig√™ncia Artificial est√° lendo sua reda√ß√£o...</div>
        <div style="margin-top:10px; font-size:0.9rem; color:var(--text-muted);">Isso pode levar alguns segundos.</div>
    </div>

    <script>
        const API_BASE = "https://backend-redacao.onrender.com/api/redacao";

        // Usa Auth
        const userId = window.UserSession.id;

        const temaAtual = localStorage.getItem('temaRedacao') || "Tema Livre";
        document.getElementById('temaDisplay').innerText = temaAtual;

        function contarPalavras() {
            const texto = document.getElementById('textoRedacao').value;
            const palavras = texto.trim() === '' ? 0 : texto.trim().split(/\s+/).length;
            document.getElementById('wordCount').innerText = `${palavras} palavras`;
        }

        async function enviarParaCorrecao() {
            const texto = document.getElementById('textoRedacao').value;
            const btn = document.getElementById('btnEnviar');
            const loading = document.getElementById('loadingOverlay');

            if (texto.length < 50) {
                alert("Sua reda√ß√£o est√° muito curta! Escreva pelo menos um par√°grafo.");
                return;
            }

            btn.disabled = true;
            loading.style.display = 'flex';

            try {
                const response = await fetch(`${API_BASE}/enviar-redacao`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        texto: texto,
                        tema: temaAtual,
                        userId: userId
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.erro || 'Erro ao conectar com o servidor');
                }

                loading.style.display = 'none';
                document.querySelector('.editor-box').style.display = 'none';
                document.getElementById('resultadoContainer').style.display = 'block';

                document.getElementById('notaFinal').innerText = data.resultado.notaFinal;
                
                let feedbackHTML = `<p style="font-size:1.1rem; margin-bottom:20px; color:#4B5563;">${data.resultado.analiseGeral && data.resultado.analiseGeral.length > 0 ? data.resultado.analiseGeral[0] : "Parab√©ns pela reda√ß√£o!"}</p>`;

                if (data.resultado.competencias) {
                    feedbackHTML += "<div style='display:flex; flex-direction:column; gap:10px;'>";
                    
                    for (const [key, dados] of Object.entries(data.resultado.competencias)) {
                        let errosHTML = '';
                        if(dados.erros && dados.erros.length > 0) {
                            errosHTML = `<div style="margin-top:4px; font-size:0.85rem; color:#DC2626;">
                                ${dados.erros.map(e => `‚Ä¢ ${e.descricao} <span style="opacity:0.7">(${e.acao})</span>`).join('<br>')}
                            </div>`;
                        }

                        feedbackHTML += `
                            <div style="background:#F3F4F6; padding:15px; border-radius:8px; border-left: 4px solid var(--primary);">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <strong style="color:#111827; font-size:1rem;">${dados.nome || key.toUpperCase()}</strong>
                                    <span style="font-weight:700; color:var(--primary); font-size:1.1rem;">${dados.nota} pts</span>
                                </div>
                                ${errosHTML}
                            </div>`;
                    }
                    feedbackHTML += "</div>";
                }

                document.getElementById('feedbackTexto').innerHTML = feedbackHTML;

                if (data.resultado.notaFinal >= 700) {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                }

            } catch (error) {
                console.error(error);
                loading.style.display = 'none';
                btn.disabled = false;
                alert("Erro: " + error.message);
            }
        }
    </script>
</body>
</html>
