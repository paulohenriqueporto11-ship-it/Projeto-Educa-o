<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Reda√ß√£o - Estuda.IA</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>

    <nav>
        <div class="nav-left">
            <a href="index.html" class="btn-outline" style="border:none; padding:8px 12px; margin-right:15px; font-weight:600;">‚¨Ö Voltar</a>
            <div class="logo">üìù Reda√ß√£o.IA</div>
        </div>
        <div class="nav-right">
             <div class="study-timer" id="wordCount">0 palavras</div>
        </div>
    </nav>

    <div class="container">
        <div style="background:white; padding:20px; border-radius:16px; border:1px solid var(--border); margin-bottom:20px; box-shadow: var(--shadow-sm);">
            <span style="text-transform:uppercase; font-size:0.75rem; color:var(--text-muted); font-weight:700;">Tema Escolhido</span>
            <h2 id="temaDisplay" style="margin-top:5px; color:var(--primary);">Carregando tema...</h2>
        </div>

        <div class="editor-box" style="width:100%; max-width:100%; padding:0; background:transparent; border:none; box-shadow:none;">
            <textarea id="textoRedacao" class="main-input" placeholder="Comece a digitar sua reda√ß√£o aqui... M√≠nimo 50 caracteres." oninput="contarPalavras()"></textarea>
            
            <div style="display:flex; justify-content:flex-end; margin-top:20px;">
                <button id="btnEnviar" class="btn" onclick="enviarParaCorrecao()">
                    üöÄ Enviar para Corre√ß√£o
                </button>
            </div>
        </div>

        <div id="resultadoContainer" style="display:none; margin-top:30px; animation: slideUp 0.5s ease;">
            <div class="score-hero">
                <div class="val" id="notaFinal">0</div>
                <div class="label">Nota Geral</div>
            </div>

            <div style="background:white; padding:25px; border-radius:16px; border:1px solid var(--border); margin-top:20px;">
                <h3>üìä An√°lise Detalhada</h3>
                <div id="feedbackTexto" style="margin-top:15px; line-height:1.6; color:var(--text-main);"></div>
            </div>
            
            <button class="btn-outline" style="width:100%; margin-top:20px; padding:15px;" onclick="window.location.href='index.html'">
                Voltar ao Painel
            </button>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loader"></div>
        <div class="loading-text">A Intelig√™ncia Artificial est√° lendo sua reda√ß√£o...</div>
        <div style="margin-top:10px; font-size:0.9rem; color:var(--text-muted);">Isso pode levar alguns segundos.</div>
    </div>

    <script>
        // URL DO SEU BACKEND NO RENDER
        const API_BASE = "https://backend-redacao.onrender.com/api/redacao"
        // 1. RECUPERAR DADOS DO LOCALSTORAGE
        // Usamos 'estuda_ia_userid' para manter consist√™ncia com o Cronograma
        let userId = localStorage.getItem('estuda_ia_userid');
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('estuda_ia_userid', userId);
        }

        const temaAtual = localStorage.getItem('temaRedacao') || "Tema Livre";
        document.getElementById('temaDisplay').innerText = temaAtual;

        // 2. CONTADOR DE PALAVRAS
        function contarPalavras() {
            const texto = document.getElementById('textoRedacao').value;
            const palavras = texto.trim() === '' ? 0 : texto.trim().split(/\s+/).length;
            document.getElementById('wordCount').innerText = `${palavras} palavras`;
        }

        // 3. ENVIAR PARA CORRE√á√ÉO
        async function enviarParaCorrecao() {
            const texto = document.getElementById('textoRedacao').value;
            const btn = document.getElementById('btnEnviar');
            const loading = document.getElementById('loadingOverlay');

            if (texto.length < 50) {
                alert("Sua reda√ß√£o est√° muito curta! Escreva pelo menos um par√°grafo.");
                return;
            }

            // UI: Loading state
            btn.disabled = true;
            loading.style.display = 'flex';

            try {
                const response = await fetch(`${API_BASE}/enviar-redacao`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        texto: texto,
                        tema: temaAtual,
                        userId: userId
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.erro || 'Erro ao conectar com o servidor');
                }

                // SUCESSO: Mostrar Resultado
                loading.style.display = 'none';
                document.querySelector('.editor-box').style.display = 'none'; // Esconde editor
                document.getElementById('resultadoContainer').style.display = 'block'; // Mostra nota

                // Preencher dados
                document.getElementById('notaFinal').innerText = data.resultado.notaFinal;
                
                // Formata o feedback (Assumindo que a IA retorna um comentarioGeral ou array de competencias)
                // Ajuste conforme o retorno exato do seu arquivo corretor.js
                let feedbackHTML = `<p>${data.resultado.comentarioGeral || "Parab√©ns pela reda√ß√£o!"}</p>`;
                
                // Se tiver detalhamento por compet√™ncia (opcional)
                if (data.resultado.competencias) {
                    feedbackHTML += "<hr style='margin:15px 0; border-top:1px solid #eee'>";
                    for (const [comp, nota] of Object.entries(data.resultado.competencias)) {
                        feedbackHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <strong>${comp}:</strong> <span>${nota} pontos</span>
                        </div>`;
                    }
                }

                document.getElementById('feedbackTexto').innerHTML = feedbackHTML;

                // Confete se nota boa
                if (data.resultado.notaFinal >= 700) {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                }

            } catch (error) {
                console.error(error);
                loading.style.display = 'none';
                btn.disabled = false;
                alert("Erro: " + error.message);
            }
        }
    </script>
</body>
</html>
