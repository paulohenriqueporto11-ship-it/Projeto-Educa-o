<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Rotina - Estuda.IA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <link href="assets/css/style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>

    <div id="statsModal" class="stats-overlay">
        <div class="stats-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <h2>üìä Seu Desempenho</h2>
                <button class="btn-outline" style="border:none; color:white; font-size:1.5rem;" onclick="closeStats()">√ó</button>
            </div>

            <div class="big-stats-grid">
                <div class="big-stat">
                    <div class="big-val" id="statTotalMissions">0</div>
                    <div class="big-label">Miss√µes Conclu√≠das</div>
                </div>
                <div class="big-stat">
                    <div class="big-val" id="statTotalDays">0</div>
                    <div class="big-label">Dias Estudados</div>
                </div>
                <div class="big-stat">
                    <div class="big-val" id="statMaxStreak">0</div>
                    <div class="big-label">Maior Ofensiva</div>
                </div>
            </div>

            <h3 style="color:#9CA3AF; font-size:0.9rem; text-transform:uppercase; margin-bottom:10px;">Consist√™ncia (√öltimos 3 Meses)</h3>
            <div class="heatmap-container">
                <div class="heatmap-grid" id="heatmap"></div>
            </div>
            
            <div style="margin-top:20px; display:flex; gap:10px; font-size:0.8rem; color:#9CA3AF; align-items:center;">
                <span>Menos</span>
                <div class="day-square" data-level="0"></div>
                <div class="day-square" data-level="1"></div>
                <div class="day-square" data-level="2"></div>
                <div class="day-square" data-level="3"></div>
                <span>Mais</span>
            </div>
        </div>
    </div>

    <nav>
        <div class="logo">‚ú® Estuda.IA</div>
        <div style="display:flex; align-items:center; gap:15px;">
            <div class="study-timer" id="globalTimer">00:00:00</div>
            <button class="btn-outline" style="border:none; font-size:1.2rem;" onclick="openStats()">üìä</button>
            <a href="index.html" class="btn-outline" style="border:none; font-weight:600;">‚Üê Sair</a>
        </div>
    </nav>

    <div class="container">
        
        <div class="level-container">
            <div class="level-badge" id="userLevel">1</div>
            <div class="xp-bar-wrapper">
                <div class="xp-info">
                    <span>N√≠vel <span id="lvlNum">1</span></span>
                    <span id="xpDisplay">0 / 1000 XP</span>
                </div>
                <div class="xp-track">
                    <div class="xp-fill" id="xpBar" style="width: 0%"></div>
                </div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:0.8rem; opacity:0.8">Ofensiva</div>
                <div style="font-weight:800; color:#F59E0B">üî• <span id="streakDay">0</span> dias</div>
            </div>
        </div>

        <div class="view-toggle">
            <div class="toggle-btn active" id="viewDaily" onclick="switchView('daily')">Miss√µes de Hoje</div>
            <div class="toggle-btn" id="viewWeekly" onclick="switchView('weekly')">Vis√£o Semanal</div>
        </div>

        <div id="dailyContainer">
            <div id="missionsList"></div>
            
            <div id="bonusContainer" style="display:none; text-align:center; margin-top:30px; padding-top:20px; border-top:1px dashed var(--border);">
                <p style="color:var(--text-muted); margin-bottom:15px;">Voc√™ completou tudo por hoje! Que tal um desafio extra?</p>
                <button class="btn" style="background: linear-gradient(135deg, #4F46E5, #9333EA);" onclick="generateBonusMission()">
                    üíé Gerar Miss√£o B√¥nus (+300 XP)
                </button>
            </div>
        </div>

        <div id="weeklyContainer" style="display: none;">
            <div class="weekly-grid" id="weeklyGrid"></div>
        </div>

    </div>

    <script>
        // =========================================================
        // 1. DADOS & ESTADO
        // =========================================================
        const CONSTANTS = { XP_PER_LEVEL: 1000 };
        
        // Simula√ß√£o de "Banco de Miss√µes B√¥nus"
        const BONUS_POOL = [
            { t: "Desafio de L√≥gica", d: "Resolva 1 problema dif√≠cil de an√°lise combinat√≥ria.", i: "üß†", url: "simulados.html", type: "Matem√°tica" },
            { t: "Repert√≥rio Flash", d: "Leia sobre 1 fil√≥sofo novo em 10min.", i: "‚ö°", url: "redacao.html" },
            { t: "Ingl√™s R√°pido", d: "Traduza o refr√£o de uma m√∫sica.", i: "üéµ", url: "simulados.html", type: "Linguagens" }
        ];

        let state = JSON.parse(localStorage.getItem('estudaia_state_v4')) || {
            config: { subjects: ['red', 'mat'], intensity: 'medio' },
            user: { xp: 0, streak: 1, lastLogin: null },
            dailyPlan: { date: null, missions: [], bonusAdded: false },
            history: {} // '2023-10-27': ['id1', 'id2']
        };

        const todayDate = new Date().toISOString().split('T')[0];

        function saveState() {
            localStorage.setItem('estudaia_state_v4', JSON.stringify(state));
        }

        // =========================================================
        // 2. GERA√á√ÉO DE MISS√ïES (Normal & B√¥nus)
        // =========================================================
        function checkAndGenerateDailyMissions() {
            // Se mudou o dia, reseta
            if (state.dailyPlan.date !== todayDate) {
                // L√≥gica de Streak: Se pulou mais de 1 dia, zera (exceto primeiro uso)
                if (state.user.lastLogin) {
                    const diff = (new Date(todayDate) - new Date(state.user.lastLogin)) / (1000 * 3600 * 24);
                    if (diff >= 2) state.user.streak = 0; // Perdeu
                    else if (diff >= 1) state.user.streak++; // Ganhou
                }
                
                // Gera novas miss√µes (Mockup simplificado do V3)
                const count = state.config.intensity === 'hard' ? 5 : 3;
                let newMissions = [];
                for(let i=0; i<count; i++) {
                    newMissions.push({
                        id: `${todayDate}_${i}`,
                        t: "Miss√£o Di√°ria " + (i+1),
                        d: "Foco na mat√©ria principal.",
                        i: "üìö",
                        xp: 150,
                        url: "simulados.html"
                    });
                }

                state.dailyPlan = { date: todayDate, missions: newMissions, bonusAdded: false };
                state.user.lastLogin = todayDate;
                saveState();
            }
            renderMissionsUI();
        }

        function generateBonusMission() {
            if(state.dailyPlan.bonusAdded) return;
            
            const randomBonus = BONUS_POOL[Math.floor(Math.random() * BONUS_POOL.length)];
            const bonusMission = {
                ...randomBonus,
                id: `${todayDate}_bonus`,
                isBonus: true,
                xp: 300
            };
            
            state.dailyPlan.missions.push(bonusMission);
            state.dailyPlan.bonusAdded = true;
            saveState();
            renderMissionsUI();
            
            // Efeito visual
            confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 } });
        }

        // =========================================================
        // 3. UI RENDER (Cards e L√≥gica de Conclus√£o)
        // =========================================================
        function renderMissionsUI() {
            const list = document.getElementById('missionsList');
            const history = state.history[todayDate] || [];
            let html = '';
            let completedCount = 0;

            state.dailyPlan.missions.forEach(m => {
                const isDone = history.includes(m.id);
                if (isDone) completedCount++;
                
                // Estilo especial se for b√¥nus
                const bonusClass = m.isBonus ? 'bonus' : '';
                const icon = m.isBonus ? 'üíé' : m.i;

                html += `
                    <div class="mission-card ${bonusClass} ${isDone ? 'mission-done' : ''}">
                        <div class="mission-left">
                            <div class="mission-icon">${icon}</div>
                            <div class="mission-info">
                                <h3>${m.t} ${m.isBonus ? '<span style="font-size:0.7em; color:#FBBF24">‚òÖ B√îNUS</span>' : ''}</h3>
                                <p>${m.d}</p>
                                <span class="xp-badge">+${m.xp} XP</span>
                            </div>
                        </div>
                        <button class="btn-start" onclick="completeMission('${m.id}', ${m.xp})">
                            ${isDone ? 'Feito ‚úÖ' : 'Iniciar'}
                        </button>
                    </div>
                `;
            });

            list.innerHTML = html;
            updateGamificationUI();

            // Mostra bot√£o de b√¥nus se completou todas as normais e ainda n√£o pegou b√¥nus
            const totalNormais = state.dailyPlan.missions.filter(m => !m.isBonus).length;
            const normaisFeitas = state.dailyPlan.missions.filter(m => !m.isBonus && history.includes(m.id)).length;
            
            if (normaisFeitas >= totalNormais && !state.dailyPlan.bonusAdded) {
                document.getElementById('bonusContainer').style.display = 'block';
            } else {
                document.getElementById('bonusContainer').style.display = 'none';
            }
        }

        function completeMission(id, xp) {
            if (!state.history[todayDate]) state.history[todayDate] = [];
            
            if (!state.history[todayDate].includes(id)) {
                state.history[todayDate].push(id);
                state.user.xp += xp;
                saveState();
                renderMissionsUI();
                if(id.includes('bonus')) confetti();
            } else {
                // Se j√° fez, pode navegar (simula√ß√£o)
                // window.location.href = ...
            }
        }

        function updateGamificationUI() {
            const xp = state.user.xp;
            const level = Math.floor(xp / 1000) + 1;
            document.getElementById('userLevel').innerText = level;
            document.getElementById('lvlNum').innerText = level;
            document.getElementById('xpDisplay').innerText = `${xp % 1000} / 1000 XP`;
            document.getElementById('xpBar').style.width = `${(xp % 1000)/10}%`;
            document.getElementById('streakDay').innerText = state.user.streak;
        }

        // =========================================================
        // 4. HIST√ìRICO & ESTAT√çSTICAS (Heatmap Engine)
        // =========================================================
        function openStats() {
            document.getElementById('statsModal').style.display = 'flex';
            renderHeatmap();
            calculateBigStats();
        }

        function closeStats() {
            document.getElementById('statsModal').style.display = 'none';
        }

        function calculateBigStats() {
            // 1. Total Miss√µes
            let totalMissions = 0;
            let totalDays = 0;
            
            Object.values(state.history).forEach(dayList => {
                if (dayList.length > 0) {
                    totalMissions += dayList.length;
                    totalDays++;
                }
            });

            document.getElementById('statTotalMissions').innerText = totalMissions;
            document.getElementById('statTotalDays').innerText = totalDays;
            document.getElementById('statMaxStreak').innerText = state.user.streak; // Simplificado
        }

        function renderHeatmap() {
            const container = document.getElementById('heatmap');
            container.innerHTML = '';
            
            // Gera √∫ltimos 90 dias (aprox 12 semanas)
            const today = new Date();
            const squares = [];
            
            // Vamos gerar 84 dias (12 semanas * 7 dias)
            for (let i = 83; i >= 0; i--) {
                const d = new Date();
                d.setDate(today.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                
                const count = state.history[dateStr] ? state.history[dateStr].length : 0;
                let level = 0;
                if (count > 0) level = 1;
                if (count > 2) level = 2;
                if (count > 4) level = 3;

                const div = document.createElement('div');
                div.className = 'day-square';
                div.setAttribute('data-level', level);
                div.title = `${dateStr}: ${count} miss√µes`;
                squares.push(div);
            }
            
            squares.forEach(sq => container.appendChild(sq));
        }

        // =========================================================
        // 5. INICIALIZA√á√ÉO
        // =========================================================
        // Timer Global (Persistente)
        let totalSeconds = parseInt(localStorage.getItem('estudaia_timer')) || 0;
        setInterval(() => {
            totalSeconds++;
            localStorage.setItem('estudaia_timer', totalSeconds);
            const h = Math.floor(totalSeconds/3600).toString().padStart(2,'0');
            const m = Math.floor((totalSeconds%3600)/60).toString().padStart(2,'0');
            const timerEl = document.getElementById('globalTimer');
            if(timerEl) timerEl.innerText = `${h}:${m}`;
        }, 1000);

        function switchView(view) {
            if(view === 'daily') {
                document.getElementById('dailyContainer').style.display = 'block';
                document.getElementById('weeklyContainer').style.display = 'none';
                document.getElementById('viewDaily').classList.add('active');
                document.getElementById('viewWeekly').classList.remove('active');
            } else {
                document.getElementById('dailyContainer').style.display = 'none';
                document.getElementById('weeklyContainer').style.display = 'block';
                document.getElementById('viewDaily').classList.remove('active');
                document.getElementById('viewWeekly').classList.add('active');
                
                // Gera resumo simples semanal
                const container = document.getElementById('weeklyGrid');
                container.innerHTML = `
                    <div class="day-card"><div class="day-name">DOM</div><div class="day-load">-</div></div>
                    <div class="day-card"><div class="day-name">SEG</div><div class="day-load">3 üéØ</div></div>
                    <div class="day-card"><div class="day-name">TER</div><div class="day-load">3 üéØ</div></div>
                    <div class="day-card"><div class="day-name">QUA</div><div class="day-load">3 üéØ</div></div>
                    <div class="day-card"><div class="day-name">QUI</div><div class="day-load">3 üéØ</div></div>
                    <div class="day-card"><div class="day-name">SEX</div><div class="day-load">3 üéØ</div></div>
                    <div class="day-card"><div class="day-name">S√ÅB</div><div class="day-load">-</div></div>
                `;
            }
        }

        checkAndGenerateDailyMissions();

    </script>
</body>
</html>
