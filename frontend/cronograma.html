<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Rotina - Estuda.IA 2.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="assets/css/style.css">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
    <audio id="audio-rain" loop src="https://actions.google.com/sounds/v1/weather/heavy_rain.ogg"></audio>
    <audio id="audio-lofi" loop src="https://codeskulptor-demos.commondatastorage.googleapis.com/GalaxyInvaders/theme_01.mp3"></audio> <audio id="audio-white" loop src="https://actions.google.com/sounds/v1/water/air_conditioner_hum.ogg"></audio>

    <div id="configModal" class="modal-overlay" style="display:none;"> 
        <div class="modal-box">
            <h2>üöÄ Seu Cronograma</h2>
            <p style="color:var(--text-muted); margin-bottom:20px;">O que vamos destruir hoje?</p>

            <label style="font-weight:600;">Escolha o Foco:</label>
            <div class="track-grid" id="trackSelector">
                <div class="track-option" onclick="selectTrack(this, 'med')">ü©∫ Sa√∫de</div>
                <div class="track-option" onclick="selectTrack(this, 'eng')">üìê Exatas</div>
                <div class="track-option" onclick="selectTrack(this, 'hum')">‚öñÔ∏è Humanas</div>
                <div class="track-option" onclick="selectTrack(this, 'custom')">‚öôÔ∏è Personalizado</div>
            </div>

            <div id="customArea" class="custom-track-input">
                <p style="font-size:0.8rem; margin-bottom:5px;">Selecione as mat√©rias:</p>
                <div style="display:flex; gap:5px; flex-wrap:wrap;">
                    <button class="subject-chip" onclick="toggleSubject(this, 'mat')">Matem√°tica</button>
                    <button class="subject-chip" onclick="toggleSubject(this, 'red')">Reda√ß√£o</button>
                    <button class="subject-chip" onclick="toggleSubject(this, 'nat')">Natureza</button>
                    <button class="subject-chip" onclick="toggleSubject(this, 'hum')">Humanas</button>
                </div>
            </div>

            <div class="slider-container">
                <div class="slider-label">
                    <span>Meta de Tempo</span>
                    <span id="hoursVal" style="color:var(--primary)">2h 00m</span>
                </div>
                <input type="range" min="0.5" max="8" step="0.5" value="2" id="hoursInput" oninput="updateHoursLabel(this.value)">
            </div>

            <button class="btn-save" onclick="saveConfig()">Salvar & Gerar</button>
        </div>
    </div>

    <nav>
        <div class="logo">‚ú® Estuda.IA</div>
        <div class="nav-right">
             <div class="study-timer" id="navTimer">00:00</div>
             <button class="btn-outline" onclick="openConfig()">‚öôÔ∏è</button>
        </div>
    </nav>

    <div class="container page-cronograma">
        
        <div class="timer-deck">
            <h3 style="margin-bottom:20px; opacity:0.8">Modo Foco Profundo</h3>
            
            <div class="timer-ring" id="timerRing">
                <div class="timer-inner">
                    <div class="timer-display" id="displayTimer">00:00</div>
                    <div class="timer-label" id="timerStatus">Pronto?</div>
                </div>
            </div>
            
            <div class="timer-controls">
                <button class="btn-timer btn-stop" onclick="resetTimer()">‚èπ Reset</button>
                <button class="btn-timer btn-play" id="playBtn" onclick="toggleTimer()">‚ñ∂ INICIAR</button>
            </div>

            <a href="#" onclick="openConfig(); return false;" class="timer-config-link">
                ‚öôÔ∏è Ajustar Tempo e Mat√©ria
            </a>

            <div class="sound-bar">
                <button class="sound-btn" id="btn-rain" onclick="toggleAudio('rain')">üåß Chuva</button>
                <button class="sound-btn" id="btn-lofi" onclick="toggleAudio('lofi')">‚òï Music</button>
                <button class="sound-btn" id="btn-white" onclick="toggleAudio('white')">üìª Ru√≠do</button>
            </div>
        </div>

        <div>
            <div style="margin-bottom:20px;">
                <h2 id="trackTitle">Suas Miss√µes</h2>
                <p style="color:var(--text-muted)">Complete para ganhar XP e manter a ofensiva.</p>
            </div>
            <div id="missionsList">
                </div>
        </div>
    </div>

    <script>
        // ===========================================
        // 1. GEST√ÉO DE ESTADO (Persist√™ncia)
        // ===========================================
        
        // Tenta carregar do LocalStorage, sen√£o usa padr√£o
        const savedData = localStorage.getItem('estudaia_v3_state');
        
        let state = savedData ? JSON.parse(savedData) : {
            firstVisit: true,        // Controla se o modal abre sozinho
            track: 'med',            // Valor padr√£o seguro
            customSubjects: [],
            goalMinutes: 120,
            elapsedSeconds: 0,
            isRunning: false,
            completed: []            // IDs das miss√µes completas
        };

        // Reset Di√°rio (Se virou o dia, limpa as miss√µes feitas, mas mant√©m a config)
        const todayKey = new Date().toLocaleDateString();
        if (state.lastDate !== todayKey) {
            state.completed = []; // Reseta conclus√µes
            state.elapsedSeconds = 0; // Reseta timer
            state.lastDate = todayKey;
            saveState(); // Salva o reset
        }

        function saveState() {
            localStorage.setItem('estudaia_v3_state', JSON.stringify(state));
        }

        // ===========================================
        // 2. BANCO DE QUEST√ïES
        // ===========================================
        const DB = {
            mat: { t: "Matem√°tica", d: "Lista: Geometria Plana", xp: 150, i: "üìê", url: "simulados.html?materia=matematica" },
            red: { t: "Reda√ß√£o", d: "Escrever: Tema da Semana", xp: 300, i: "üìù", url: "redacao.html" },
            nat: { t: "Natureza", d: "Revis√£o: Estequiometria", xp: 150, i: "üß™", url: "simulados.html?materia=natureza" },
            hum: { t: "Humanas", d: "Quiz: Revolu√ß√£o Industrial", xp: 100, i: "üè∫", url: "simulados.html?materia=humanas" },
            
            // Presets (Trilhas prontas)
            med: ['nat', 'nat', 'red', 'mat'],
            eng: ['mat', 'mat', 'nat', 'red'],
            hum: ['hum', 'hum', 'red', 'mat']
        };

        // ===========================================
        // 3. INICIALIZA√á√ÉO INTELIGENTE
        // ===========================================
        
        window.onload = function() {
            if (state.firstVisit) {
                // Se √© a 1¬™ vez, abre o modal
                openConfig();
            } else {
                // Se j√° configurou, carrega direto
                renderMissions();
                updateDisplay(); // Restaura o visual do timer
                updateHoursLabel(state.goalMinutes / 60);
            }
        };

        // ===========================================
        // 4. L√ìGICA DO MODAL
        // ===========================================
        
        function openConfig() { 
            document.getElementById('configModal').style.display = 'flex'; 
            
            // Restaura visualmente a escolha salva
            const savedTrack = state.track || 'med';
            const opts = document.querySelectorAll('.track-option');
            opts.forEach(el => {
                if(el.textContent.toLowerCase().includes(savedTrack === 'custom' ? 'personalizado' : savedTrack)) {
                    // Simples match de texto para UI
                    selectTrack(el, savedTrack);
                }
            });
            
            // Restaura o slider
            document.getElementById('hoursInput').value = state.goalMinutes / 60;
            updateHoursLabel(state.goalMinutes / 60);
        }
        
        function selectTrack(el, type) {
            document.querySelectorAll('.track-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            
            // Mostra area personalizada se for custom
            document.getElementById('customArea').style.display = (type === 'custom') ? 'block' : 'none';
            
            // N√£o salvamos no state ainda, s√≥ quando clicar em SALVAR
            el.dataset.tempType = type; 
        }

        function toggleSubject(btn, subj) {
            btn.classList.toggle('selected');
            // L√≥gica visual apenas, salvamos no final
        }

        function updateHoursLabel(val) {
            const h = Math.floor(val);
            const m = (val % 1) * 60;
            document.getElementById('hoursVal').innerText = `${h}h ${m===0?'00':m}m`;
        }

        function saveConfig() {
            // 1. Pega o tipo selecionado
            const selectedOpt = document.querySelector('.track-option.selected');
            const type = selectedOpt ? (selectedOpt.dataset.tempType || selectedOpt.getAttribute('onclick').split("'")[1]) : 'med';
            
            state.track = type;
            state.firstVisit = false; // Nunca mais abre sozinho
            
            // 2. Se for custom, pega as mat√©rias
            if (type === 'custom') {
                const selectedChips = document.querySelectorAll('.subject-chip.selected');
                state.customSubjects = Array.from(selectedChips).map(c => c.getAttribute('onclick').split("'")[1]);
                if(state.customSubjects.length === 0) state.customSubjects = ['mat', 'red']; // Fallback
            }

            // 3. Pega o tempo
            const val = document.getElementById('hoursInput').value;
            state.goalMinutes = val * 60;

            saveState(); // Persiste
            
            document.getElementById('configModal').style.display = 'none';
            renderMissions();
            resetTimer(); 
        }

        // ===========================================
        // 5. RENDERIZA√á√ÉO
        // ===========================================
        
        function renderMissions() {
            const list = document.getElementById('missionsList');
            list.innerHTML = '';
            
            let subjectsToLoad = [];
            
            if (state.track === 'custom') {
                subjectsToLoad = state.customSubjects.length > 0 ? state.customSubjects : ['red', 'mat'];
            } else {
                subjectsToLoad = DB[state.track] || DB['med'];
            }

            subjectsToLoad.forEach((key, idx) => {
                const missionData = DB[key] || DB['mat'];
                const isDone = state.completed.includes(idx);
                
                const div = document.createElement('div');
                div.className = `mission-card ${isDone ? 'mission-done' : ''}`;
                
                div.innerHTML = `
                    <div class="mission-left">
                        <div class="mission-icon">${missionData.i}</div>
                        <div class="mission-info">
                            <h3>${missionData.t}</h3>
                            <p>${missionData.d}</p>
                            <span class="xp-badge">+${missionData.xp} XP</span>
                        </div>
                    </div>
                    <a href="${missionData.url}" class="btn-start" onclick="markAsDone(${idx})">
                        ${isDone ? 'Conclu√≠do ‚úÖ' : 'Ir Agora ‚ûî'}
                    </a>
                `;
                list.appendChild(div);
            });

            const titles = { med: 'Foco Sa√∫de', eng: 'Foco Exatas', hum: 'Foco Humanas', custom: 'Personalizado' };
            document.getElementById('trackTitle').innerText = titles[state.track] || 'Cronograma';
        }

        function markAsDone(idx) {
            if(!state.completed.includes(idx)) {
                state.completed.push(idx);
                saveState();
                
                // Efeito Confete
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                
                // Pequeno delay para recarregar visual (opcional)
                setTimeout(() => renderMissions(), 500);
            }
        }

        // ===========================================
        // 6. TIMER & AUDIO
        // ===========================================
        
        let timerInterval = null;
        let currentAudio = null;

        function toggleTimer() {
            const btn = document.getElementById('playBtn');
            const status = document.getElementById('timerStatus');

            if (state.isRunning) {
                clearInterval(timerInterval);
                state.isRunning = false;
                btn.innerText = "‚ñ∂ CONTINUAR";
                btn.style.background = "#4F46E5";
                status.innerText = "Pausado";
            } else {
                state.isRunning = true;
                btn.innerText = "‚è∏ PAUSAR";
                btn.style.background = "#F59E0B";
                status.innerText = "Focando...";
                
                timerInterval = setInterval(() => {
                    state.elapsedSeconds++;
                    if(state.elapsedSeconds % 5 === 0) saveState(); // Salva a cada 5s
                    updateDisplay();
                }, 1000);
            }
            saveState();
        }

        function resetTimer() {
            clearInterval(timerInterval);
            state.isRunning = false;
            state.elapsedSeconds = 0;
            saveState();
            
            document.getElementById('playBtn').innerText = "‚ñ∂ INICIAR";
            document.getElementById('playBtn').style.background = "#10B981";
            document.getElementById('timerStatus').innerText = "Pronto?";
            updateDisplay();
        }

        function updateDisplay() {
            const hours = Math.floor(state.elapsedSeconds / 3600);
            const minutes = Math.floor((state.elapsedSeconds % 3600) / 60);
            const seconds = state.elapsedSeconds % 60;

            const fmt = (n) => n.toString().padStart(2, '0');
            const timeString = hours > 0 
                ? `${fmt(hours)}:${fmt(minutes)}:${fmt(seconds)}` 
                : `${fmt(minutes)}:${fmt(seconds)}`;

            document.getElementById('displayTimer').innerText = timeString;
            document.getElementById('navTimer').innerText = timeString;

            const totalGoalSeconds = state.goalMinutes * 60;
            let percent = (state.elapsedSeconds / totalGoalSeconds) * 100;
            if (percent > 100) percent = 100;
            
            document.getElementById('timerRing').style.background = 
                `conic-gradient(#10B981 ${percent}%, rgba(255,255,255,0.1) 0%)`;
        }

        function toggleAudio(type) {
            const audioEl = document.getElementById(`audio-${type}`);
            const btn = document.getElementById(`btn-${type}`);

            // Pausa o atual se clicar no mesmo
            if (currentAudio === type) {
                audioEl.pause();
                currentAudio = null;
                btn.classList.remove('playing');
                return;
            }

            // Reseta todos os outros
            ['rain', 'lofi', 'white'].forEach(t => {
                const el = document.getElementById(`audio-${t}`);
                const b = document.getElementById(`btn-${t}`);
                el.pause();
                el.currentTime = 0; // Volta para o come√ßo
                b.classList.remove('playing');
            });

            // Toca o novo
            audioEl.volume = 0.6;
            const playPromise = audioEl.play();

            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    // Play funcionou
                    currentAudio = type;
                    btn.classList.add('playing');
                })
                .catch(error => {
                    console.log("Erro de Autoplay (Interaja com a p√°gina primeiro):", error);
                    alert("Clique na p√°gina antes de dar play no som!");
                });
            }
        }
    </script>
</body>
</html>
