<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Rotina - Estuda.IA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <link href="assets/css/style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>

    <div id="configModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 650px;">
            <h2 style="margin-bottom: 10px;">Personalize seu Estudo</h2>
            <p style="color:var(--text-muted); margin-bottom: 20px;">Escolha o que focar. Presets ajustam as mat√©rias automaticamente.</p>

            <div class="focus-grid" style="grid-template-columns: repeat(3, 1fr); margin-top: 10px; margin-bottom: 20px;">
                <button class="btn-outline" onclick="applyPreset('med')">ü©∫ Medicina</button>
                <button class="btn-outline" onclick="applyPreset('eng')">üìê Engenharia</button>
                <button class="btn-outline" onclick="applyPreset('dir')">‚öñÔ∏è Direito</button>
            </div>

            <label style="font-weight:700; font-size:0.9rem;">MAT√âRIAS SELECIONADAS</label>
            <div class="chips-container" id="subjectChips">
                <div class="subject-chip" data-val="mat" onclick="toggleSubject(this)">Matem√°tica</div>
                <div class="subject-chip" data-val="nat" onclick="toggleSubject(this)">Natureza</div>
                <div class="subject-chip" data-val="hum" onclick="toggleSubject(this)">Humanas</div>
                <div class="subject-chip" data-val="lin" onclick="toggleSubject(this)">Linguagens</div>
                <div class="subject-chip" data-val="red" onclick="toggleSubject(this)">Reda√ß√£o</div>
            </div>

            <label style="font-weight:700; font-size:0.9rem; margin-top:15px;">INTENSIDADE DI√ÅRIA</label>
            <div class="intensity-selector">
                <button class="intensity-btn" data-val="leve" onclick="setIntensity('leve')">Leve (1)</button>
                <button class="intensity-btn" data-val="medio" onclick="setIntensity('medio')">M√©dio (3)</button>
                <button class="intensity-btn" data-val="hard" onclick="setIntensity('hard')">Hardcore (5)</button>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeConfig()">Cancelar</button>
                <button class="btn" style="flex:2" onclick="saveConfig()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <nav>
        <div class="logo">‚ú® Estuda.IA</div>
        <div style="display:flex; align-items:center; gap:15px;">
            <div class="study-timer" id="globalTimer" title="Tempo total estudado">00:00:00</div>
            <a href="index.html" class="btn-outline" style="border:none; font-weight:600;">‚Üê Sair</a>
        </div>
    </nav>

    <div class="container">
        
        <div class="level-container">
            <div class="level-badge" id="userLevel">1</div>
            <div class="xp-bar-wrapper">
                <div class="xp-info">
                    <span>N√≠vel <span id="lvlNum">1</span></span>
                    <span id="xpDisplay">0 / 1000 XP</span>
                </div>
                <div class="xp-track">
                    <div class="xp-fill" id="xpBar" style="width: 0%"></div>
                </div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:0.8rem; opacity:0.8">Ofensiva</div>
                <div style="font-weight:800">üî• <span id="streakDay">0</span> dias</div>
            </div>
        </div>

        <div class="streak-bar" style="background:var(--surface); color:var(--text-main); border:1px solid var(--border); box-shadow:var(--shadow-sm);">
            <div>
                <div style="font-size: 0.9rem; color:var(--text-muted);">Meta de Hoje</div>
                <div style="font-weight: 700; font-size:1.1rem;" id="todayGoalLabel">--</div>
            </div>
            <button class="btn" style="padding: 8px 20px; font-size:0.9rem;" onclick="openConfig()">
                ‚öôÔ∏è Configurar Rotina
            </button>
        </div>

        <div class="view-toggle">
            <div class="toggle-btn active" id="viewDaily" onclick="switchView('daily')">Miss√µes de Hoje</div>
            <div class="toggle-btn" id="viewWeekly" onclick="switchView('weekly')">Vis√£o Semanal</div>
        </div>

        <div id="dailyContainer">
            <div id="missionsList"></div>
        </div>

        <div id="weeklyContainer" style="display: none;">
            <h3 style="margin-bottom: 20px; text-align:center;">Seu Planejamento</h3>
            <div class="weekly-grid" id="weeklyGrid"></div>
            <div style="margin-top:30px; text-align:center; color:var(--text-muted); font-size:0.9rem;">
                * A carga hor√°ria √© baseada na sua configura√ß√£o de intensidade.
            </div>
        </div>

    </div>

    <script>
        // =========================================================
        // 1. DADOS (DATA LAYER)
        // =========================================================
        const CONSTANTS = {
            XP_PER_LEVEL: 1000,
            INTENSITY_MAP: { 'leve': 1, 'medio': 3, 'hard': 5 }
        };

        const MISSION_POOL = {
            mat: [
                { t: "Matem√°tica B√°sica", d: "Revise fra√ß√µes e porcentagem.", i: "‚ûó", url: "simulados.html", type: "Matem√°tica" },
                { t: "Geometria Plana", d: "√Åreas e per√≠metros.", i: "üìê", url: "simulados.html", type: "Matem√°tica" },
                { t: "Fun√ß√µes", d: "Resolva 3 problemas de 1¬∫ grau.", i: "üìà", url: "simulados.html", type: "Matem√°tica" },
                { t: "Estat√≠stica", d: "M√©dia, Moda e Mediana.", i: "üìä", url: "simulados.html", type: "Matem√°tica" }
            ],
            nat: [
                { t: "Mec√¢nica", d: "Leis de Newton na pr√°tica.", i: "üçé", url: "simulados.html", type: "Natureza" },
                { t: "Estequiometria", d: "C√°lculos qu√≠micos b√°sicos.", i: "üß™", url: "simulados.html", type: "Natureza" },
                { t: "Citologia", d: "Estrutura das c√©lulas.", i: "üß¨", url: "simulados.html", type: "Natureza" }
            ],
            hum: [
                { t: "Brasil Col√¥nia", d: "Ciclo do A√ß√∫car e Ouro.", i: "üè∞", url: "simulados.html", type: "Humanas" },
                { t: "Geografia F√≠sica", d: "Climas e Relevo do Brasil.", i: "üåç", url: "simulados.html", type: "Humanas" },
                { t: "Filosofia Antiga", d: "S√≥crates, Plat√£o e Arist√≥teles.", i: "üèõÔ∏è", url: "simulados.html", type: "Humanas" }
            ],
            lin: [
                { t: "Figuras de Linguagem", d: "Met√°fora, Meton√≠mia, etc.", i: "üó£Ô∏è", url: "simulados.html", type: "Linguagens" },
                { t: "Interpreta√ß√£o", d: "Leia e resolva 5 quest√µes.", i: "üìñ", url: "simulados.html", type: "Linguagens" }
            ],
            red: [
                { t: "Reda√ß√£o Completa", d: "Escreva sobre um tema atual.", i: "üìù", url: "redacao.html" },
                { t: "Compet√™ncia 1", d: "Revise erros de crase.", i: "‚úçÔ∏è", url: "redacao.html" },
                { t: "Projeto de Texto", d: "Planeje apenas os argumentos.", i: "üß†", url: "redacao.html" }
            ]
        };

        // =========================================================
        // 2. ESTADO E PERSIST√äNCIA
        // =========================================================
        let state = JSON.parse(localStorage.getItem('estudaia_state_v3')) || {
            config: { subjects: ['red', 'mat'], intensity: 'medio' },
            user: { xp: 0, streak: 1, lastLogin: null },
            dailyPlan: { date: null, missions: [] },
            history: {} // '2023-10-27': ['mission_id_1']
        };

        const todayDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

        function saveState() {
            localStorage.setItem('estudaia_state_v3', JSON.stringify(state));
        }

        // =========================================================
        // 3. L√ìGICA DE TIMER (SEM DRIFT)
        // =========================================================
        function initTimer() {
            // Se n√£o tiver tempo de in√≠cio, define agora
            if(!localStorage.getItem('timer_start_check')) {
                localStorage.setItem('timer_start_check', Date.now());
                localStorage.setItem('timer_bank', 0); // Tempo acumulado em ms
            }

            setInterval(() => {
                // O tempo total √© o Banco Salvo + (Agora - √öltimo Start)
                // Para simplificar no MVP, vamos somar e salvar a cada segundo, 
                // mas usar Date.now() garante precis√£o se a p√°gina recarregar.
                
                let totalSecs = parseInt(localStorage.getItem('estudaia_total_seconds') || 0);
                // S√≥ incrementa se a janela estiver focada (opcional, aqui conta sempre que aberto)
                totalSecs++;
                localStorage.setItem('estudaia_total_seconds', totalSecs);
                
                const h = Math.floor(totalSecs / 3600).toString().padStart(2,'0');
                const m = Math.floor((totalSecs % 3600) / 60).toString().padStart(2,'0');
                const s = (totalSecs % 60).toString().padStart(2,'0');
                document.getElementById('globalTimer').innerText = `${h}:${m}:${s}`;
            }, 1000);
        }

        // =========================================================
        // 4. GERA√á√ÉO DE MISS√ïES (ROTATIVAS)
        // =========================================================
        function checkAndGenerateDailyMissions() {
            // Se j√° tem plano pra hoje, n√£o faz nada
            if (state.dailyPlan.date === todayDate && state.dailyPlan.missions.length > 0) {
                renderMissionsUI();
                return;
            }

            // Gera novo plano
            const count = CONSTANTS.INTENSITY_MAP[state.config.intensity];
            let activeSubjects = [...state.config.subjects];
            if (activeSubjects.length === 0) activeSubjects = ['red']; // Fallback

            let newMissions = [];
            
            // Usa o dia do ano para rotacionar as miss√µes (Shuffle determin√≠stico)
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);

            for (let i = 0; i < count; i++) {
                const subKey = activeSubjects[i % activeSubjects.length];
                const pool = MISSION_POOL[subKey];
                
                // Pega miss√£o baseada no dia para n√£o repetir sempre a primeira
                const missionIndex = (dayOfYear + i) % pool.length; 
                const missionData = pool[missionIndex];

                newMissions.push({
                    id: `${todayDate}_${subKey}_${i}`,
                    ...missionData
                });
            }

            // Atualiza Streak se for dia consecutivo
            if (state.user.lastLogin) {
                const last = new Date(state.user.lastLogin);
                const now = new Date(todayDate);
                const diffTime = Math.abs(now - last);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                if (diffDays === 1) state.user.streak++;
                else if (diffDays > 1) state.user.streak = 1;
            }
            
            state.user.lastLogin = todayDate;
            state.dailyPlan = { date: todayDate, missions: newMissions };
            saveState();
            renderMissionsUI();
        }

        // =========================================================
        // 5. RENDERIZA√á√ÉO DA UI
        // =========================================================
        function renderMissionsUI() {
            const list = document.getElementById('missionsList');
            const history = state.history[todayDate] || [];
            let html = '';

            state.dailyPlan.missions.forEach(m => {
                const isDone = history.includes(m.id);
                const btnAction = isDone ? 'Revisar' : (m.url.includes('redacao') ? 'Escrever' : 'Iniciar');
                
                // A√ß√£o do bot√£o: Se √© simulado, passa o tipo
                const clickFn = m.url.includes('simulados') 
                    ? `goToSimulado('${m.type}', '${m.id}')`
                    : `goToLink('${m.url}', '${m.id}')`;

                html += `
                    <div class="mission-card ${isDone ? 'mission-done' : ''}">
                        <div class="mission-left">
                            <div class="mission-icon">${m.i}</div>
                            <div class="mission-info">
                                <h3>${m.t}</h3>
                                <p>${m.d}</p>
                            </div>
                        </div>
                        <button class="btn-start" onclick="${clickFn}">
                            ${isDone ? 'Conclu√≠do ‚úÖ' : btnAction + ' ‚Üí'}
                        </button>
                    </div>
                `;
            });

            list.innerHTML = html;
            updateGamificationUI();
            
            // Atualiza texto da meta
            const total = state.dailyPlan.missions.length;
            const done = history.length;
            document.getElementById('todayGoalLabel').innerText = `${done}/${total} Conclu√≠das`;
        }

        function updateGamificationUI() {
            const xp = state.user.xp;
            const level = Math.floor(xp / CONSTANTS.XP_PER_LEVEL) + 1;
            const xpInLevel = xp % CONSTANTS.XP_PER_LEVEL;
            const percent = (xpInLevel / CONSTANTS.XP_PER_LEVEL) * 100;

            document.getElementById('userLevel').innerText = level;
            document.getElementById('lvlNum').innerText = level;
            document.getElementById('xpDisplay').innerText = `${xpInLevel} / ${CONSTANTS.XP_PER_LEVEL} XP`;
            document.getElementById('xpBar').style.width = `${percent}%`;
            document.getElementById('streakDay').innerText = state.user.streak;
        }

        function renderWeeklyView() {
            const container = document.getElementById('weeklyGrid');
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            const todayIdx = new Date().getDay();
            const intensityVal = CONSTANTS.INTENSITY_MAP[state.config.intensity];

            let html = '';
            days.forEach((day, idx) => {
                const isToday = idx === todayIdx ? 'active' : '';
                html += `
                    <div class="day-card ${isToday}">
                        <div class="day-name">${day}</div>
                        <div class="day-load">${intensityVal} üéØ</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // =========================================================
        // 6. A√á√ïES & NAVEGA√á√ÉO
        // =========================================================
        function goToLink(url, id) {
            completeMission(id);
            setTimeout(() => window.location.href = url, 500);
        }

        function goToSimulado(type, id) {
            completeMission(id);
            localStorage.setItem('simulado_auto_start', type);
            setTimeout(() => window.location.href = 'simulados.html', 500);
        }

        function completeMission(id) {
            if (!state.history[todayDate]) state.history[todayDate] = [];
            
            if (!state.history[todayDate].includes(id)) {
                state.history[todayDate].push(id);
                state.user.xp += 150; // XP por miss√£o
                saveState();
                
                // Efeito Confete üéâ
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }

        function switchView(view) {
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            if(view === 'daily') {
                document.getElementById('viewDaily').classList.add('active');
                document.getElementById('dailyContainer').style.display = 'block';
                document.getElementById('weeklyContainer').style.display = 'none';
            } else {
                document.getElementById('viewWeekly').classList.add('active');
                document.getElementById('dailyContainer').style.display = 'none';
                document.getElementById('weeklyContainer').style.display = 'block';
                renderWeeklyView();
            }
        }

        // =========================================================
        // 7. MODAL DE CONFIGURA√á√ÉO (L√ìGICA)
        // =========================================================
        let tempSubjects = [];
        let tempIntensity = 'medio';

        function openConfig() {
            // Sincroniza estado atual com UI do modal
            tempSubjects = [...state.config.subjects];
            tempIntensity = state.config.intensity;
            
            updateChipsUI();
            updateIntensityUI();
            
            document.getElementById('configModal').style.display = 'flex';
        }

        function closeConfig() {
            document.getElementById('configModal').style.display = 'none';
        }

        // Fecha ao clicar fora
        document.getElementById('configModal').addEventListener('click', (e) => {
            if (e.target.id === 'configModal') closeConfig();
        });

        function toggleSubject(el) {
            const val = el.dataset.val;
            if (tempSubjects.includes(val)) {
                tempSubjects = tempSubjects.filter(s => s !== val);
            } else {
                tempSubjects.push(val);
            }
            updateChipsUI();
        }

        function updateChipsUI() {
            document.querySelectorAll('.subject-chip').forEach(chip => {
                if (tempSubjects.includes(chip.dataset.val)) chip.classList.add('selected');
                else chip.classList.remove('selected');
            });
        }

        function setIntensity(val) {
            tempIntensity = val;
            updateIntensityUI();
        }

        function updateIntensityUI() {
            document.querySelectorAll('.intensity-btn').forEach(btn => {
                if (btn.dataset.val === tempIntensity) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        }

        function applyPreset(type) {
            if(type === 'med') tempSubjects = ['nat', 'red', 'nat', 'mat'];
            if(type === 'eng') tempSubjects = ['mat', 'nat', 'mat', 'red'];
            if(type === 'dir') tempSubjects = ['hum', 'lin', 'hum', 'red'];
            updateChipsUI();
        }

        function saveConfig() {
            if(tempSubjects.length === 0) return alert("Selecione pelo menos uma mat√©ria!");
            
            // Verifica se mudou algo que exige regerar o plano
            const changed = JSON.stringify(state.config.subjects) !== JSON.stringify(tempSubjects) ||
                            state.config.intensity !== tempIntensity;

            state.config.subjects = tempSubjects;
            state.config.intensity = tempIntensity;
            
            if(changed) {
                // For√ßa regera√ß√£o do plano de hoje
                state.dailyPlan = { date: null, missions: [] };
            }
            
            saveState();
            closeConfig();
            checkAndGenerateDailyMissions();
        }

        // =========================================================
        // STARTUP
        // =========================================================
        initTimer();
        
        // Se nunca configurou, abre modal
        if (state.config.subjects.length === 0 && !localStorage.getItem('estudaia_onboarded')) {
            localStorage.setItem('estudaia_onboarded', 'true');
            openConfig();
        } else {
            checkAndGenerateDailyMissions();
        }

    </script>
</body>
</html>
