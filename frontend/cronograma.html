<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Rotina - Estuda.IA 2.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="auth.js"></script>
</head>
<body>
    <audio id="audio-rain" loop preload="auto" src="https://assets.mixkit.co/active_storage/sfx/2479/2479-preview.mp3"></audio>
    <audio id="audio-lofi" loop preload="auto" src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3"></audio>
    <audio id="audio-white" loop preload="auto" src="https://assets.mixkit.co/active_storage/sfx/2177/2177-preview.mp3"></audio>

    <div id="configModal" class="modal-overlay" style="display:none;"> 
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0;">üöÄ Configura√ß√£o</h2>
                <span onclick="closeConfig()" style="font-size:1.8rem; cursor:pointer; color:var(--text-muted);">&times;</span>
            </div>
            <p style="color:var(--text-muted); margin-bottom:20px;">Personalize sua jornada.</p>

            <label style="font-weight:600;">Sua Trilha:</label>
            <div class="track-grid" id="trackSelector">
                <div class="track-option" onclick="selectTrack(this, 'med')">ü©∫ Sa√∫de</div>
                <div class="track-option" onclick="selectTrack(this, 'eng')">üìê Exatas</div>
                <div class="track-option" onclick="selectTrack(this, 'hum')">‚öñÔ∏è Humanas</div>
                <div class="track-option" onclick="selectTrack(this, 'custom')">‚öôÔ∏è Custom</div>
            </div>

            <div id="customArea" class="custom-track-input">
                <p style="font-size:0.8rem; margin-bottom:5px;">Mat√©rias:</p>
                <div style="display:flex; gap:5px; flex-wrap:wrap;">
                    <button class="subject-chip" onclick="toggleSubject(this, 'mat')">Matem√°tica</button>
                    <button class="subject-chip" onclick="toggleSubject(this, 'red')">Reda√ß√£o</button>
                    <button class="subject-chip" onclick="toggleSubject(this, 'nat')">Natureza</button>
                    <button class="subject-chip" onclick="toggleSubject(this, 'hum')">Humanas</button>
                </div>
            </div>

            <div class="slider-container">
                <div class="slider-label">
                    <span>Meta Di√°ria</span>
                    <span id="hoursVal" style="color:var(--primary)">2h 00m</span>
                </div>
                <input type="range" min="0.5" max="8" step="0.5" value="2" id="hoursInput" oninput="updateHoursLabel(this.value)">
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeConfig()">Cancelar</button>
                <button class="btn-save" onclick="saveConfig()">Salvar</button>
            </div>
        </div>
    </div>

    <nav>
        <div class="nav-left">
            <a href="index.html" class="btn-outline" style="border:none; padding:8px 12px; margin-right:15px; font-weight:600;">‚¨Ö Voltar</a>
            <div class="logo">‚ú® Estuda.IA</div>
        </div>
        <div class="nav-right">
             <div class="study-timer" id="navTimer">00:00</div>
             <button class="btn-outline" onclick="openConfig()" title="Configurar">‚öôÔ∏è</button>
             <a id="authBtn" href="login.html" class="btn-outline" style="border:none; font-weight:600; margin-left:10px;">Entrar</a>
        </div>
    </nav>

    <div class="container page-cronograma">
        
        <div class="timer-deck">
            <h3 style="margin-bottom:20px; opacity:0.8">Modo Foco</h3>
            <div class="timer-ring" id="timerRing">
                <div class="timer-inner">
                    <div class="timer-display" id="displayTimer">00:00</div>
                    <div class="timer-label" id="timerStatus">Pronto?</div>
                </div>
            </div>
            <div class="timer-controls">
                <button class="btn-timer btn-stop" onclick="resetTimer()">‚èπ Reset</button>
                <button class="btn-timer btn-play" id="playBtn" onclick="toggleTimer()">‚ñ∂ INICIAR</button>
            </div>
            <a onclick="openConfig()" class="timer-config-link">‚öôÔ∏è Ajustar Meta</a>
            <div class="sound-bar">
                <button class="sound-btn" id="btn-rain" onclick="toggleAudio('rain')">üåß Chuva</button>
                <button class="sound-btn" id="btn-lofi" onclick="toggleAudio('lofi')">‚òï Lo-Fi</button>
                <button class="sound-btn" id="btn-white" onclick="toggleAudio('white')">üìª Ru√≠do</button>
            </div>
        </div>

        <div>
            <div class="gamification-bar">
                <div class="level-info">
                    <div class="level-badge" id="lvlBadge">1</div>
                    <div class="xp-container">
                        <div class="xp-text">
                            <span>N√≠vel <span id="lvlText">1</span></span>
                            <span id="xpText">0/1000 XP</span>
                        </div>
                        <div class="xp-bg"><div class="xp-fill" id="xpFill"></div></div>
                    </div>
                </div>
                <div class="streak-info">
                    üî• <span id="streakVal">0</span> dias seguidos
                </div>
            </div>

            <div style="background: white; padding: 15px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px;">
                <h4 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px;">Sua Consist√™ncia (√öltimos 14 dias)</h4>
                <div class="heatmap-box" id="heatmapGrid"></div>
            </div>

            <div style="margin-bottom:20px;">
                <h2 id="trackTitle">Miss√µes de Hoje</h2>
            </div>
            
            <div id="missionsList">
                <div style="text-align:center; padding:20px; color:#6B7280;">
                    Carregando seu progresso...
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://backend-redacao.onrender.com/api/cronograma'; 

        // Usa Auth
        const USER_ID = window.UserSession.id;

        let state = {
            track: 'med',
            customSubjects: [],
            goalMinutes: 120,
            elapsedSeconds: 0,
            isRunning: false,
            totalXP: 0,
            streak: 0,
            completedToday: [],
            heatmapData: []
        };

        const DB = {
            mat: { t: "Matem√°tica", d: "Lista: Geometria Espacial", xp: 200, i: "üìê", url: "simulados.html?materia=matematica" },
            red: { t: "Reda√ß√£o", d: "Escrever: Tema 'IA na Educa√ß√£o'", xp: 350, i: "üìù", url: "redacao.html" },
            nat: { t: "Natureza", d: "Revis√£o: Eletrodin√¢mica", xp: 200, i: "‚ö°", url: "simulados.html?materia=natureza" },
            hum: { t: "Humanas", d: "Resumo: Era Vargas", xp: 150, i: "üìú", url: "simulados.html?materia=humanas" },
            med: ['nat', 'nat', 'red', 'mat'],
            eng: ['mat', 'mat', 'nat', 'red'],
            hum: ['hum', 'hum', 'red', 'mat']
        };

        window.onload = async function() {
            try {
                const res = await fetch(`${API_BASE}/dados`, {
                    headers: { 'x-user-id': USER_ID }
                });
                
                if (!res.ok) throw new Error('Erro na API');
                const data = await res.json();

                state.track = data.config.track;
                state.goalMinutes = data.config.goal_minutes;
                state.customSubjects = data.config.custom_subjects;
                
                state.totalXP = data.stats.total_xp;
                state.streak = data.stats.streak;
                
                state.completedToday = data.completedToday; 
                state.heatmapData = data.history;

                renderMissions();
                renderGamification();
                renderHeatmap();
                updateDisplay();
                updateHoursLabel(state.goalMinutes / 60);

                if (data.stats.total_xp === 0 && !data.config.track) {
                    openConfig();
                }

            } catch (err) {
                console.error("Falha ao carregar dados:", err);
                document.getElementById('missionsList').innerHTML = `<p style="color:red; text-align:center">Erro ao conectar com o servidor.<br>Verifique se o backend est√° rodando.</p>`;
            }
        };

        async function saveConfig() {
            const sel = document.querySelector('.track-option.selected');
            const type = sel ? (sel.dataset.tempType || 'med') : 'med';
            const val = document.getElementById('hoursInput').value;
            let customSubs = [];

            if (type === 'custom') {
                const chips = document.querySelectorAll('.subject-chip.selected');
                customSubs = Array.from(chips).map(c => c.getAttribute('onclick').split("'")[1]);
            }

            state.track = type;
            state.goalMinutes = val * 60;
            state.customSubjects = customSubs;

            closeConfig();
            renderMissions();
            resetTimer();

            try {
                await fetch(`${API_BASE}/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-user-id': USER_ID },
                    body: JSON.stringify({
                        track: type,
                        goalMinutes: state.goalMinutes,
                        customSubjects: customSubs
                    })
                });
            } catch (e) { console.error("Erro ao salvar config", e); }
        }

        async function completeMission(e, idx, xp) {
            if (!state.completedToday.includes(idx)) {
                state.completedToday.push(idx);
                state.totalXP += xp;
                
                confetti({ particleCount: 80, spread: 60, origin: { y: 0.6 } });
                spawnFloatingXP(xp, e.clientX, e.clientY);
                renderGamification(); 

                const today = new Date().toISOString().split('T')[0];
                fetch(`${API_BASE}/concluir`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-user-id': USER_ID },
                    body: JSON.stringify({ missionId: idx, xpEarned: xp, date: today })
                }).catch(e => console.error("Erro ao salvar miss√£o", e));

                e.preventDefault();
                const url = e.currentTarget.getAttribute('href');
                setTimeout(() => {
                    renderMissions(); 
                    window.location.href = url;
                }, 800);
            }
        }

        function renderGamification() {
            const level = Math.floor(state.totalXP / 1000) + 1;
            const xpCurrent = state.totalXP % 1000;
            const xpPercent = (xpCurrent / 1000) * 100;

            document.getElementById('lvlBadge').innerText = level;
            document.getElementById('lvlText').innerText = level;
            document.getElementById('xpText').innerText = `${xpCurrent}/1000 XP`;
            document.getElementById('xpFill').style.width = `${xpPercent}%`;
            document.getElementById('streakVal').innerText = state.streak;
        }

        function renderHeatmap() {
            const grid = document.getElementById('heatmapGrid');
            grid.innerHTML = '';
            
            const map = {};
            if(state.heatmapData) {
                state.heatmapData.forEach(item => {
                    const dateKey = new Date(item.created_at || item.date).toISOString().split('T')[0]; 
                    if(item.count) {
                        map[dateKey] = item.count;
                    } else {
                        if(!map[dateKey]) map[dateKey] = 0;
                        map[dateKey]++;
                    }
                });
            }

            for (let i = 13; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const k = d.toISOString().split('T')[0];
                const count = map[k] || 0;
                let cls = '';
                if (count >= 4) cls = 'active-3'; 
                else if (count >= 2) cls = 'active-2'; 
                else if (count >= 1) cls = 'active-1';
                
                const div = document.createElement('div');
                div.className = `heatmap-day ${cls}`;
                div.title = `${k}: ${count} miss√µes`;
                grid.appendChild(div);
            }
        }

        function renderMissions() {
            const list = document.getElementById('missionsList');
            list.innerHTML = '';
            
            let load = (state.track === 'custom') ? 
                (state.customSubjects && state.customSubjects.length ? state.customSubjects : ['red']) : 
                (DB[state.track] || DB['med']);

            load.forEach((key, idx) => {
                const data = DB[key] || DB['mat'];
                const isDone = state.completedToday.includes(idx);
                
                const div = document.createElement('div');
                div.className = `mission-card ${isDone ? 'mission-done' : ''}`;
                div.innerHTML = `
                    <div class="mission-left">
                        <div class="mission-icon">${data.i}</div>
                        <div class="mission-info">
                            <h3>${data.t}</h3>
                            <p>${data.d}</p>
                            <span class="xp-badge">+${data.xp} XP</span>
                        </div>
                    </div>
                    <a href="${data.url}" class="btn-start" onclick="completeMission(event, ${idx}, ${data.xp})">
                        ${isDone ? 'Feito ‚úÖ' : 'Iniciar ‚ûî'}
                    </a>
                `;
                list.appendChild(div);
            });
            const titles = { med: 'Foco Sa√∫de', eng: 'Foco Exatas', hum: 'Foco Humanas', custom: 'Personalizado' };
            document.getElementById('trackTitle').innerText = titles[state.track] || 'Cronograma';
        }

        function spawnFloatingXP(amount, x, y) {
            const el = document.createElement('div');
            el.className = 'floating-xp';
            el.innerText = `+${amount} XP`;
            el.style.left = `${x}px`; el.style.top = `${y}px`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        let timerInterval = null;
        let currentAudio = null;

        function toggleTimer() {
            const btn = document.getElementById('playBtn');
            const status = document.getElementById('timerStatus');
            if (state.isRunning) {
                clearInterval(timerInterval);
                state.isRunning = false;
                btn.innerText = "‚ñ∂ CONTINUAR"; btn.style.background = "#4F46E5"; status.innerText = "Pausado";
            } else {
                state.isRunning = true;
                btn.innerText = "‚è∏ PAUSAR"; btn.style.background = "#F59E0B"; status.innerText = "Focando...";
                timerInterval = setInterval(() => {
                    state.elapsedSeconds++;
                    updateDisplay();
                }, 1000);
            }
        }

        function resetTimer() {
            clearInterval(timerInterval);
            state.isRunning = false; state.elapsedSeconds = 0;
            document.getElementById('playBtn').innerText = "‚ñ∂ INICIAR"; document.getElementById('playBtn').style.background = "#10B981";
            document.getElementById('timerStatus').innerText = "Pronto?";
            updateDisplay();
        }

        function updateDisplay() {
            const h = Math.floor(state.elapsedSeconds / 3600);
            const m = Math.floor((state.elapsedSeconds % 3600) / 60);
            const s = state.elapsedSeconds % 60;
            const fmt = n => n.toString().padStart(2, '0');
            const str = h > 0 ? `${fmt(h)}:${fmt(m)}:${fmt(s)}` : `${fmt(m)}:${fmt(s)}`;
            
            document.getElementById('displayTimer').innerText = str;
            document.getElementById('navTimer').innerText = str;

            const total = state.goalMinutes * 60;
            let pct = (state.elapsedSeconds / total) * 100;
            if(pct > 100) pct = 100;
            document.getElementById('timerRing').style.background = `conic-gradient(#10B981 ${pct}%, rgba(255,255,255,0.1) 0%)`;
        }

        function toggleAudio(type) {
            const el = document.getElementById(`audio-${type}`);
            const btn = document.getElementById(`btn-${type}`);
            if (currentAudio === type) {
                el.pause(); currentAudio = null; btn.classList.remove('playing');
                return;
            }
            ['rain', 'lofi', 'white'].forEach(t => {
                const other = document.getElementById(`audio-${t}`);
                const b = document.getElementById(`btn-${t}`);
                other.pause(); other.currentTime = 0; b.classList.remove('playing');
            });
            el.volume = 0.5;
            const promise = el.play();
            if (promise !== undefined) {
                promise.then(() => { currentAudio = type; btn.classList.add('playing'); })
                .catch(err => console.warn("Autoplay bloqueado. Interaja com a p√°gina primeiro."));
            }
        }

        function openConfig() { 
            document.getElementById('configModal').style.display = 'flex'; 
            updateHoursLabel(state.goalMinutes / 60); 
            document.getElementById('hoursInput').value = state.goalMinutes / 60;
            
            const opts = document.querySelectorAll('.track-option');
            opts.forEach(el => {
                el.classList.remove('selected');
                if (el.getAttribute('onclick').includes(state.track)) el.classList.add('selected');
            });
        }
        function closeConfig() { document.getElementById('configModal').style.display = 'none'; }
        
        function selectTrack(el, type) {
            document.querySelectorAll('.track-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('customArea').style.display = (type === 'custom') ? 'block' : 'none';
            el.dataset.tempType = type;
        }
        function toggleSubject(btn, subj) { btn.classList.toggle('selected'); }
        function updateHoursLabel(val) {
            const h = Math.floor(val); const m = (val % 1) * 60;
            document.getElementById('hoursVal').innerText = `${h}h ${m===0?'00':m}m`;
        }
    </script>
</body>
</html>
